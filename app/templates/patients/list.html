{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <h2 class="text-primary mb-0"><i class="fas fa-users me-2"></i>Patient List</h2>
      <div>
        {% if current_user.is_authenticated and current_user.role in ['admin', 'staff'] %}
        <a href="{{ url_for('patients.add_patient_form') }}" class="btn btn-primary me-2">
          <i class="fas fa-user-plus"></i> Add Patient
        </a>
        {% endif %}
        <a href="{{ url_for('wards.list_wards') }}" class="btn btn-outline-primary me-2" data-bs-toggle="tooltip" title="View all wards">
          <i class="fas fa-hospital"></i> Wards
        </a>
        <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-outline-success me-2" data-bs-toggle="tooltip" title="Go to dashboard">
          <i class="fas fa-chart-line"></i> Dashboard
        </a>
        <a href="{{ url_for('teams.list_teams') }}" class="btn btn-outline-info" data-bs-toggle="tooltip" title="View all teams">
          <i class="fas fa-user-md"></i> Teams
        </a>
      </div>
    </div>
  </div>
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-body">
      <div class="d-flex justify-content-end mb-3">
        <input type="text" id="patientSearch" class="form-control w-25" placeholder="Search by name, ward, or team..." />
      </div>
      {% if current_user.is_authenticated and current_user.role in ['admin', 'staff'] %}
      {% endif %}
      {% if patients %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle" id="patientsTable">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Gender</th>
              <th>Age</th>
              <th>Admission Date</th>
              <th>Ward</th>
              <th>Team</th>
              <th>Details</th>
              {% if current_user.is_authenticated and current_user.role in ['admin', 'staff'] %}
              <th>Actions</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for patient in patients %}
            <tr>
              <td>{{ patient.name }}</td>
              <td>
                {% if patient.gender|lower == 'male' %}Male{% elif patient.gender|lower == 'female' %}Female{% else %}{{ patient.gender|capitalize }}{% endif %}
              </td>
              <td>{{ patient.age }}</td>
              <td>{{ patient.admission_date.strftime('%Y-%m-%d') }}</td>
              <td>{{ patient.assigned_ward.name }}</td>
              <td>{{ patient.treatment_team.name }}</td>
              <td>
                <a href="{{ url_for('patients.patient_details', id=patient.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="View details">
                  <i class="fas fa-eye"></i> View
                </a>
              </td>
              {% if current_user.is_authenticated and current_user.role in ['admin', 'staff'] %}
              <td>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#transferPatientModal{{ patient.id }}">
                    <i class="fas fa-exchange-alt"></i> Transfer
                  </button>
                  <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#editPatientModal{{ patient.id }}">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <form method="POST" action="{{ url_for('patients.discharge_patient', id=patient.id) }}" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Discharge this patient?');"><i class="fas fa-sign-out-alt"></i> Discharge</button>
                  </form>
                  <form method="POST" action="{{ url_for('patients.delete_patient', id=patient.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this patient?');">
                    <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i> Delete</button>
                  </form>
                </div>
                <!-- Edit Patient Modal -->
                <div class="modal fade" id="editPatientModal{{ patient.id }}" tabindex="-1" aria-labelledby="editPatientModalLabel{{ patient.id }}" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <form method="POST" action="{{ url_for('patients.edit_patient', id=patient.id) }}">
                        <div class="modal-header">
                          <h5 class="modal-title" id="editPatientModalLabel{{ patient.id }}"><i class="fas fa-edit me-2"></i>Edit Patient</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <div class="mb-3">
                            <label for="editPatientName{{ patient.id }}" class="form-label">Name</label>
                            <input type="text" class="form-control" id="editPatientName{{ patient.id }}" name="name" value="{{ patient.name }}" required>
                          </div>
                          <div class="mb-3">
                            <label for="editPatientAge{{ patient.id }}" class="form-label">Age</label>
                            <input type="number" class="form-control" id="editPatientAge{{ patient.id }}" name="age" value="{{ patient.age }}" min="0" required>
                          </div>
                          <div class="mb-3">
                            <label for="editPatientGender{{ patient.id }}" class="form-label">Gender</label>
                            <select class="form-select" id="editPatientGender{{ patient.id }}" name="gender" required>
                              <option value="male" {% if patient.gender|lower == 'male' %}selected{% endif %}>Male</option>
                              <option value="female" {% if patient.gender|lower == 'female' %}selected{% endif %}>Female</option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label for="editWardSelect{{ patient.id }}" class="form-label">Ward</label>
                            <select class="form-select" id="editWardSelect{{ patient.id }}" name="ward_id" required>
                              {% for ward in wards %}
                                <option value="{{ ward.id }}" {% if ward.id == patient.ward_id %}selected{% endif %}>{{ ward.name }} ({{ ward.type }}, Beds: {{ ward.available_beds() }})</option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="mb-3">
                            <label for="editTeamSelect{{ patient.id }}" class="form-label">Treatment Team</label>
                            <select class="form-select" id="editTeamSelect{{ patient.id }}" name="team_id" required>
                              {% for team in teams %}
                                <option value="{{ team.id }}" {% if team.id == patient.team_id %}selected{% endif %}>{{ team.name }}</option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="mb-3">
                            <label for="editAdmissionDate{{ patient.id }}" class="form-label">Admission Date</label>
                            <input type="date" class="form-control" id="editAdmissionDate{{ patient.id }}" name="admission_date" value="{{ patient.admission_date.strftime('%Y-%m-%d') }}" required>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                <!-- Transfer Modal -->
                <div class="modal fade" id="transferPatientModal{{ patient.id }}" tabindex="-1" aria-labelledby="transferPatientModalLabel{{ patient.id }}" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <form method="POST" action="{{ url_for('patients.transfer_patient', id=patient.id) }}">
                        <div class="modal-header">
                          <h5 class="modal-title" id="transferPatientModalLabel{{ patient.id }}"><i class="fas fa-exchange-alt me-2"></i>Transfer Patient</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <div class="mb-3">
                            <label for="transferWardSelect{{ patient.id }}" class="form-label">Select New Ward</label>
                            <select class="form-select" id="transferWardSelect{{ patient.id }}" name="new_ward_id" required>
                              <option value="" disabled selected>Select ward</option>
                              {% for ward in wards %}
                                {% if ward.id != patient.ward_id %}
                                  <option value="{{ ward.id }}">{{ ward.name }} ({{ ward.type }}, Beds: {{ ward.available_beds() }})</option>
                                {% endif %}
                              {% endfor %}
                            </select>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-info"><i class="fas fa-exchange-alt"></i> Transfer</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">No patients found.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script>
// Filter wards by gender and available beds in Add Patient modal
document.addEventListener('DOMContentLoaded', function() {
  var genderSelect = document.getElementById('patientGender');
  var wardSelect = document.getElementById('wardSelect');
  if (genderSelect && wardSelect) {
    function filterWards() {
      var gender = genderSelect.value;
      Array.from(wardSelect.options).forEach(function(opt) {
        if (!opt.value) return; // skip placeholder
        var wardGender = opt.getAttribute('data-gender');
        var available = parseInt(opt.getAttribute('data-available'));
        if ((gender && wardGender && gender !== wardGender) || available < 1) {
          opt.style.display = 'none';
        } else {
          opt.style.display = '';
        }
      });
      wardSelect.value = '';
    }
    genderSelect.addEventListener('change', filterWards);
    // Initial filter
    filterWards();
  }
  // Reset modal fields on open
  var addPatientModal = document.getElementById('addPatientModal');
  if (addPatientModal) {
    addPatientModal.addEventListener('shown.bs.modal', function () {
      document.getElementById('patientName').value = '';
      document.getElementById('patientAge').value = '';
      genderSelect.value = '';
      filterWards();
      document.getElementById('teamSelect').value = '';
      document.getElementById('admissionDate').value = '{{ current_date }}';
    });
  }
});
</script>
<script>
// Enable Bootstrap tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
tooltipTriggerList.forEach(function (tooltipTriggerEl) {
  new bootstrap.Tooltip(tooltipTriggerEl);
});

// Patient table search/filter
document.getElementById('patientSearch').addEventListener('keyup', function() {
    var value = this.value.toLowerCase();
    var rows = document.querySelectorAll('#patientsTable tbody tr');
    rows.forEach(function(row) {
        var name = row.children[0].textContent.toLowerCase();
        var ward = row.children[3].textContent.toLowerCase();
        var team = row.children[4].textContent.toLowerCase();
        if (name.includes(value) || ward.includes(value) || team.includes(value)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
